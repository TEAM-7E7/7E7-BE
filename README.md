# MarketClip
<h2>https://marketclip.kr/</h2>

### 😎요즘은 짧은 영상이 대세! 쇼핑에도 영상을 보는 즐거움이 있는 마켓클립!
<p align="center"><img src="https://wook-bucket.s3.ap-northeast-2.amazonaws.com/222222.png" />


<br />
<br />
  
# 👥 멤버
- Front-end: [이덕희](https://github.com/ejzl521), [장산](https://github.com/kyngmn)
- Back-end: [임선용](https://github.com/sunyongIM), [김재호](https://github.com/KimjaehoLy), [남신욱](https://github.com/tlsdnr1135)
- Designer: 이수진, 안수현
- [\[Front-End Github\]](https://github.com/TEAM-7E7/7E7-FE)
- [\[Marketclip Notion\]](https://www.notion.so/Market-Clip-b0feee01a3454f85962915faa7047410)
https://www.notion.so/BackEnd-3646a509dede404184b9128ec99c66b8
- [\[Marketclip Notion(BE)\]](https://www.notion.so/Market-Clip-b0feee01a3454f85962915faa7047410)
  
  
<br />

# 🗓 프로젝트 기간
- 2022년 6월 24일 ~ 2022년 8월 05일
  

<br><br>
# 🎞 프로젝트 발표영상 🎞
https://www.youtube.com/watch?v=sQ2qn1elfGQ

<br><br>
# 🎞 프로젝트 시연영상 🎞
https://www.youtube.com/watch?v=GsA8UhmQMKo&t=1s

<br>

# 🗺 ER Diagram
<center><img src="https://user-images.githubusercontent.com/91590293/182981843-124a76a6-b7e7-4718-83a2-2ec0c72532e4.png" width:"1200"></center>
  
<br /><br />
# 📌 API 명세서
<center><img src="https://wook-bucket.s3.ap-northeast-2.amazonaws.com/API+%EC%9A%94%EC%95%BD+%EC%82%AC%EC%A7%841.png" width:"1200"></center>

<br /><br />
  
# ⚙️ 기술 스택
  
### Front-End

<div>
<img src="http://img.shields.io/badge/-JavaScript-F7DF1E?style=for-the-badge&logo=JavaScript&logoColor=white" />
<img src="https://img.shields.io/badge/React-20232A?style=for-the-badge&logo=react&logoColor=61DAFB" />
<img src="http://img.shields.io/badge/-HTML5-E34F26?style=for-the-badge&logo=HTML5&logoColor=white" />
<img src="http://img.shields.io/badge/-CSS3-1572B6?style=for-the-badge&logo=CSS3&logoColor=white" />
<img src="https://img.shields.io/badge/Typescript-3178C6?style=for-the-badge&logo=Typescript&logoColor=white">
<img src="http://img.shields.io/badge/-Python-3776AB?style=for-the-badge&logo=Python&logoColor=white" />
</div>
<div>
<img src="https://img.shields.io/badge/Redux-764ABC?style=for-the-badge&logo=Redux&logoColor=white">
<img src="https://img.shields.io/badge/Recoil-673AB8?style=for-the-badge&logo=Recoil&logoColor=white">
<img src="https://img.shields.io/badge/React Query-FF4154?style=for-the-badge&logo=React Query&logoColor=white">
</div>
<div>
<img src="https://img.shields.io/badge/NGINX-009639?style=for-the-badge&logo=NGINX&logoColor=white">
<img src="http://img.shields.io/badge/-Amazon AWS-232F3E?style=for-the-badge&logo=Amazon AWS&logoColor=white" />
<img src="http://img.shields.io/badge/-Amazon S3-569A31?style=for-the-badge&logo=Amazon S3&logoColor=white" />
<img src="http://img.shields.io/badge/-Amazon EC2-FF4F8B?style=for-the-badge&logo=Amazon EC2&logoColor=white" />
<img src="http://img.shields.io/badge/-GitHub Actions-2088FF?style=for-the-badge&logo=GitHub Actions&logoColor=white" />
  <img src="http://img.shields.io/badge/-Cloud Front-512BD4?style=for-the-badge&logo=&logoColor=white" />
</div>  

### Back-End

<div>
  <img alt="Java" src ="https://img.shields.io/badge/Java-007396.svg?&style=for-the-badge&logo=Java&logoColor=white"/>
  <img alt="Spring Boot" src ="https://img.shields.io/badge/Spring Boot-6DB33F.svg?&style=for-the-badge&logo=Spring Boot&logoColor=white"/>
  <img alt="SonarLint" src ="https://img.shields.io/badge/SonarLint-CB2029.svg?&style=for-the-badge&logo=SonarLint&logoColor=white"/>
  <img alt="Gradle" src ="https://img.shields.io/badge/Gradle-02303A.svg?&style=for-the-badge&logo=Gradle&logoColor=white"/>
  <img alt="Spring Security" src ="https://img.shields.io/badge/Spring Security-6DB33F.svg?&style=for-the-badge&logo=Spring Security&logoColor=white"/>
</div>
<div>
  <img alt="Amazon RDS" src="https://img.shields.io/badge/Amazon RDS-527FFF?style=for-the-badge&logo=Amazon RDS&logoColor=white"/>
  <img alt="MySQL" src ="https://img.shields.io/badge/MySQL-4479A1.svg?&style=for-the-badge&logo=MySQL&logoColor=white"/>
  <img alt="Hibernate" src ="https://img.shields.io/badge/Hibernate-59666C.svg?&style=for-the-badge&logo=Hibernate&logoColor=white"/>
  <img alt="Amazon S3" src="https://img.shields.io/badge/Amazon S3-569A31?style=for-the-badge&logo=Amazon S3&logoColor=white"/>
  <img alt="Redis" src="https://img.shields.io/badge/Redis-DC382D?style=for-the-badge&logo=Redis&logoColor=white"/>
</div>
<div>
  <img alt="GitHub Actions" src="https://img.shields.io/badge/GitHub Actions-2088FF?style=for-the-badge&logo=GitHub Actions&logoColor=white"/>
  <img alt="Amazon AWS" src="https://img.shields.io/badge/Amazon AWS-232F3E?style=for-the-badge&logo=Amazon AWS&logoColor=white"/>
  <img alt="Amazon EC2" src="https://img.shields.io/badge/Amazon EC2-FF4F8B?style=for-the-badge&logo=Amazon EC2&logoColor=white"/>
  <img alt="NGINX" src="https://img.shields.io/badge/NGINX-009639?style=for-the-badge&logo=NGINX&logoColor=white">
  <img alt="Swagger" src="https://img.shields.io/badge/Swagger-59666C?style=for-the-badge&logo=Swagger&logoColor=white"/>
</div>

<br />  




# 🖼 아키텍쳐
<center><img src="https://wook-bucket.s3.ap-northeast-2.amazonaws.com/%EB%A7%88%EC%BC%93%ED%81%B4%EB%A6%BD+%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90.PNG" width:"1200"></center>

<br />
<hr/>

## 프로젝트 주요 기능 
  ### ➀ 로그인/회원가입 
  - URL: /sign-in, /sign-up
  #### 1. 소셜 로그인 및 플랫폼 자체 회원가입 + 보안
  - 소셜 로그인은 카카오/구글의 로그인 api를 이용해서 구현.
    <details>
    <summary><h4>소셜로그인</h4></summary>
    <div markdown="1">
    <img src="https://user-images.githubusercontent.com/55455103/182719213-22d011f5-8bb5-45a9-b360-6f7174f7b185.gif"/>
    </div>
    </details>
  #### 2. 플랫폼 자체 회원가입/로그인
  - 플랫폼 자체 회원가입은 이메일 인증과 닉네임 중복체크를 진행해야 하며 formik과 yup으로 form의 validation 및 state를 관리함.
    <details>
    <summary><h4>회원가입 이메일 인증</h4></summary>
    <div markdown="1">
    <img src="https://user-images.githubusercontent.com/55455103/182720016-af4be124-5ea7-4013-9c83-643ea5b0a712.gif"/>
    </div>
    </details>
    <details>
    <summary><h4>닉네임 중복확인 및 form 유효성 검증</h4></summary>
    <div markdown="1">
    <img src="https://user-images.githubusercontent.com/55455103/182720339-ab1b3004-73d9-4351-b05c-cbb5777a9b5e.gif"/>
    </div>
    </details>
  #### 3. JWT(refresh + access) / Axios Interceptor / PrivateRoute 
  - 로그인 후 서버에서 받은 refresh token과 access token을 각각 cookie와 webstorage에 저장해서 csrf와 xss 공격에 대응.
  - axios interceptor를 구현해 api 요청을 가로채서 refresh token과 access token을 넣어주고 만약 access token이 만료되었다면 refresh token으로 access token을 재발급 받은 후 refresh token과 access token을 넣어서 원래 api 호출.
  - 만약 refresh token이 만료되었다면 로그인 페이지로 리다이렉트 시킨다.
  - Private Route를 구현해서 인증이 된 사용자만 접근할 수 있는 페이지를 구현한다. 만약 인증이 되지 않은 사용자가 접근 시 alert를 띄우고 접근을 막음.
     <details>
      <summary><h4>PrivateRoute</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182728855-de871baf-8313-4bc3-b298-c939ae6f30cb.gif"/>
      </div>
    </details>


  ### ➁ 게시물 등록 → drag and drop
  - URL: /add-board
  #### 1. 게시물 등록
  - yup + formik을 이용해 게시물 등록 form의 validation 검증 및 state 관리.
  - 게시물의 이미지/비디오 갯수는 최대 5개까지 허용(초과하면 valdation schema에서 에러 메시지를 보내줌)하고 동영상의 길이는 16초 이상이면 alert를 띄워주고 form의 state에 반영되지 않음.
  - drag and drop으로 서버에 올라갈 이미지/비디오의 순서를 바꿀 수 있고 맨 앞에 있는 이미지/비디오가 썸네일이 된다.
    <details>
      <summary><h4>게시물 등록 drag and drop</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182722073-05672738-8a51-4f03-bde2-187532fa5662.gif"/>
      </div>
    </details>
    <details>
      <summary><h4>게시물 등록</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182722363-123c7ae0-3127-4145-91fb-04c1558cd385.gif"/>
      </div>
    </details>
  ### ➂ 게시물 전체보기(홈 화면 → shots 영상 클립 / 카테고리,정렬 기준 선택) 
  - URL: /
  #### 1. shorts 영상 클립
  - scroll snap을 이용해 뷰포트에 한 게시물만 들어오도록 구현.
  - 뷰포트에서 게시물이 보일 맨 위,아래 y좌표를 계산하고 scroll event를 추가하여 scroll snap된 게시물의 가운데 좌표가 그 사이에 들어가면 동영상을 자동으로 재생시키도록 video 태그를 조작.
    <details>
      <summary><h4>뷰포트 y좌표 계산 예시</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182722838-6ecc2df5-7937-45ca-bf89-9dd7e90b1266.png"/>
      </div>
    </details>
  
  - 위의 구현을 기반으로 게시물의 썸네일이 동영상일 경우 youtube shorts처럼 자동 재생
    <details>
      <summary><h4>홈 화면 shots 영상 클립</h4></summary>
      <div markdown="1">
        <p align="center"><img src="https://user-images.githubusercontent.com/55455103/182723126-84ef1001-38d8-4ac9-affb-0c43f0fc4d9f.gif"/></p>
      </div>
    </details>
  
  #### 2. infinite scroll / 카테고리, 정렬 기준 선택
  - 무한스크롤은 리액트의 useState를 사용해서 페이지에 해당하는 데이터를 이어나가는 방식이 아닌 react-query의 useInfiniteQuery 훅을 이용해서 페이지의 마지막 게시물이 보이면 자동으로 다음 페이지를 fetching하는 방식을 이용.
  -  react query의 캐싱 기능을 이용해게시물 전체보기 화면에서 카테고리 및 정렬 기준 선택 시 useInfiniteQuery의 refetch 기능을 이용해서 카테고리나 정렬 기준이 변경되면 자동으로 변경된 카테고리와 정렬 기준이 반영된 api를 첫 페이지부터 호출하는데 사용.
  -  카테고리와, 정렬 기준은 recoil-persist를 이용해 전역 상태의 저장소를 로컬 스토리지로 사용해서 즐겨찾기 기능처럼 페이지를 새로고침하거나 종료해도 남아있다.
    <details>
      <summary><h4>inifinite scroll + 카테고리 선택</h4></summary>
      <div markdown="1">
        <img src="https://user-images.githubusercontent.com/55455103/182724905-197f514e-c3a7-4dbc-8231-0b5821abe234.gif"/>
      </div>
  
  ### ➃ 게시물 상세보기 (이미지,비디오 carousel / 저장하기 / 사용자별 메뉴)
  - URL: /board/:board_id
  - dynamic routing으로 board_id에 해당하는 게시물을 api 요청을 통해 가져온다.
  #### 1. 이미지,비디오 carousel
  - 사용자가 등록한 이미지,비디오는 carousel로 보여준다. 
  - 뷰포트에 보이는 동영상일 경우 shorts 클립 영상처럼 자동재생시킨다.
    <details>
      <summary><h4>이미지,비디오 carousel / shorts 클립 영상</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182731237-ee64bc11-397f-4cea-a1a2-8a6afc1ac1ab.gif"/>
      </div>
    </details>
  #### 2. 저장하기
  - 로그인한 사용자만 이용할 수 있는 메뉴
  - jwt payload에 들어있는 사용자의 id와 db에 저장된 저장하기를 누른 사람의 id 리스트를 비교하면서 구현
  - react-query의 useQuery 훅과 useMutation 훅을 이용해서 저장하기 버튼 클릭 시 즉시 query cache를 초기화해서 저장하기가 적용된 게시물을 서버에서 불러온 후 화면에 렌더링한다.
  - 저장하기가 눌린 게시물은 노란색 북마크 버튼이 생긴다!
    <details>
      <summary><h4>저장하기 예시</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182732367-dd231645-4379-458f-8408-7a450ac36de1.gif"/>
      </div>
    </details>
  #### 3. 사용자별 메뉴
  - 로그인하지 않은 사용자는 저장하기, 1:1 채팅 보내기 메뉴가 보이지만 클릭하면 로그인을 요청하는 alert가 보임.
  - 로그인한 사용자는 저장하기, 1:1 채팅 보내기 메뉴가 사용 가능함.
  - 게시물의 작성자는 저장하기, 1:1 채팅 보내기 메뉴 대신 수정하기, 삭제하기 버튼이 보임!
    <details>
      <summary><h4>게시물 작성자가 보이는 메뉴</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182734352-b3c251eb-571b-4489-b455-a189133821c6.png"/>
      </div>
    </details>
  
  ### ⑤ 게시물 수정/삭제
  - URL: /edit_board/:board_id, 삭제는 별도의 URL 없음
  1. 게시물 수정/삭제
  - 게시물 수정은 작성자가 이전에 작성한 글의 상태를 그대로 가져와서 보여준 후 수정할 수 있게 한다.
  - 게시물 수정/삭제는 마이페이지에서 케밥 메뉴로 빠르게 수정/삭제할 수 있고 상세보기의 수정 삭제 버튼으로도 수정/삭제를 할 수 있다.
    <details>
      <summary><h4>게시물 수정/삭제</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182991651-37939d91-fb33-4b2f-872e-b98db2b34041.gif"/>
      </div>
    </details>
  ### ⑥ 채팅/거래 기능 (StompJS/SockJS)
  - URL: /chatting?board_id=:board_id&user_id=:user_id
  - 채팅/거래기능은 stateful한 상태에서 상대방의 행동에 따라 각각 다른 반응을 보여야 하므로 websocket을 이용.
  - pub/sub 구조로 실시간 채팅 및 채팅 내역 및 미 열람 채팅 수 확인
  1. 채팅 기능
  - 로그인한 사용자만 사용이 가능하며, 게시물 상세보기 페이지에서 1:1 채팅 보내기 버튼으로 이용할 수 있다.
  - 카카오톡과 유사하게 채팅을 받는 사람은 실시간으로 미열람 메시지 갯수가 증가한다.
    <details>
      <summary><h4>채팅기능</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182992992-2b4506f5-aa8c-44e2-abdb-7b3b4c4c2caa.gif"/>
      </div>
    </details>
  2. 거래 기능
  - 판매자가 거래요청 시 게시물의 상태가 거래중으로 변경되며 구매자에게 알람을 보여주고 구매자에게 알람과 메세지가 보여짐과 동시에 수락/취소 버튼이 보여짐
  - 거래중인 게시물은 수정이 불가능하며 판매자가 다른 구매자에게 거래요청을 보낼 수 없음
  - 구매자가 수락/취소 버튼을 클릭 시 구매자에게 알맞은 알람과 메세지 보여주고 거래가 완료된 게시물에는 더이상 채팅을 보낼 수 없게 구현.
  - 거래가 완료되면 게시물의 상태가 거래 완료로 바뀌고 구매자의 마이페이지에서 거래목록에서 게시물을 확인할 수 있고 판매자의 마이페이지에서 판매목록에서 게시물을 확인할 수 있다.
    <details>
      <summary><h4>거래 취소</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182996023-12d226f0-f855-4958-9b6c-f7b0af990941.gif"/>
      </div>
    </details>
    <details>
      <summary><h4>거래 수락</h4></summary>
      <div markdown="1">
      <img src="https://user-images.githubusercontent.com/55455103/182996813-d72325d3-930e-48df-86c5-3e1bede8d066.gif"/>
      </div>
    </details>

# 🔑 프로젝트 백엔드 주요 기능
  
* 로그인, 소셜 로그인 
  - 로그인 시 JWT 토큰, Refresh 토큰 발행
  - google, kakao 소셜 로그인 가능.
  - Access 토큰 만료시 Refresh토큰으로 Access토큰 재발행
  
* 채팅
  - 구매자는 원하는 게시글에 채팅을 보낼 수 있음.
  - 채팅방 삭제 시 상대방에게 상대방이 나갔다는 알람 보여줌.
  - 채팅 기능에 redis 의 pub/sub 자체 기능을 적용 시킴.

* 게시글
  - 원하는 카테고리를 다수 선택하여 게시글 조회 가능
  - querydsl 동적쿼리를 사용하여 게시글을 불러옴
  - 메인화면, 마이페이지의 판매목록/구매목록/저장목록 페이징처리

* 거래하기
  - 판매자가 구매자들중 한명에게 거래 신청을 함.
  - 거래 신청을 하면 구매자의 채팅에 수락or거절 버튼이 생김
  - 판매자가 수락or거절 누르기 전에는 게시글이 '예약중' 상태가 됨.
  - 수락) 수락 시 게시글이 '판매완료'로 바뀜
  - 거절) 거절 시 게시글이 '판매중' 상태로 바뀜

* redis 캐시 
  - 수정과 삭제가 잦지 않은 데이터에 캐시 기능을 적용해 서버 응답속도 개선
  - 게시글 상세페이지, 내가 쓴 글 보기, 내가 구매한 글 보기 적용
  - 채팅방에도 적용 했었으나, 채팅이 생길 때 마다 최신순으로 채팅방을 정렬해 주는 기능이 있어서 삭제함
  
<br />




# 💡 Trouble Shooting
<details>
  <summary>
    <b> CI/CD 작업 이후 프로젝트 명 변경으로 인한 서버 에러 발생 </b>
  </summary>
  
```bash
REPOSITORY=/home/ubuntu/
cd $REPOSITORY

APP_NAME=marketclip
JAR_NAME=$(ls $REPOSITORY/build/libs/ | grep 'SNAPSHOT.jar' | tail -n 1)
JAR_PATH=$REPOSITORY/build/libs/$JAR_NAME

CURRENT_PID=$(pgrep -f $APP_NAME)

echo ">현재 구동 중인 애플리케이션 pid: $CURRENT_PID"

if [ -z $CURRENT_PID ]
then
  echo ">현재 구동 중인 애플리케이션이 없으므로 종료하지 않습니다."
else
  echo "> kill -9 $CURRENT_PID"
  sudo kill -15 $CURRENT_PID
  sleep 5
fi
```
* ###### 프로젝트 프로젝트 명 변경으로 인해 kill 명령어가 실행되지 않아서 일어나는 오류
##### 해결
* ###### 단순히 EC2의 (전 프로젝트명의)프로젝트를 강제적으로 kill하고 재실행 해줬다
</details>

<details>
  <summary>
    <b> 스프링 시큐리티 예외처리 </b>
  </summary>
  
* ###### 스프링 시큐리티는 서블릿 필터에서 발생하는 오류라 ControllerAdvice에서 잡지 못한다.
* ###### 그래서 필터 계층에서 예외 처리를 해주어야 했다.
  
##### 해결
* ###### 시큐리티에 등록한 필터들 마다 예외 처리를 해주었다
</details>

<details>
  <summary>
    <b> 게시글 작성 시 이미지 순서 문제 </b>
  </summary>
  
* ###### 게시글을 작성 시 여러개의 사진을 올릴 수 있는데 순서가 중요함.
* ###### 수정을 할 때 새로운 이미지와 기존에 있던 이미지를 순서대로 받기가 힘듬.(다른 타입의 변수를 하나의 객체로)
  
###### 해결![베짱이](https://user-images.githubusercontent.com/68206513/182992929-09e4a00b-8e45-4cba-b279-822c08784c8d.png)

* ###### 이미지를 Url로 변환시켜주는 (S3에 저장하는) api를 따로 만들었다.
* ###### FE에서 이미지를 업로드 하는 동시에 위의 api를 호출하면 MultipartFile이 아닌 String 타입의 url이 return 되고,
* ###### 해당 url을 가지고 게시글 수정 api를 호출하는 로직으로 변경하였다
* ###### 하지만, 이 해결법에는 S3 서버의 데이터 누수가 있을 수 있기 때문에 scheduler의 관리가 필요하다
  
</details>


<details>
  <summary>
    <b> 서버 재시작 시 ChannelTopic이  사라짐</b>
  </summary>
  
* ###### 서버가 재시작 되면 메모리 저장소에 남아있는 ChannelTopic이 사라지게 되어 채팅이 비활성화 됨.
  
###### 해결 
* ###### 서버 시작시 DB에 담겨있는 채팅방 아이디를 불러와서 ChannelTopic 에 담아줌
</details>

<br />

# Team Marketclip - Backend

<br>

마켓클립 백엔드 개발진들🧡


| [임선용🔰](https://github.com/sunyongIM) | [김재호](https://github.com/KimjaehoLy) | [남신욱](https://github.com/tlsdnr1135) |                                                                                                            
| :---------------------------------: | :----------------------------------: | :-----------------------------: |
| <img src="https://user-images.githubusercontent.com/91590293/182991861-78a60df8-2de4-4a64-b20e-fb6c930e4d68.jpg" alt="임선용" width="200px"/> |  <img src="https://user-images.githubusercontent.com/68206513/182992939-620a49cc-e9d3-4d96-867a-e97477fda85a.png" alt="김재호" width="200px"/> | <img src="" alt="남신욱" width="200px" /> |
| `백엔드 CI/CD` `이메일 인증` `회원정보 CRUD` <br> `게시글 CRUD` `즐겨찾기` `마이페이지` <br> `queryDsl 동적쿼리` `Redis - 캐싱, 분산락` <br> `Scheduler - Mysql, S3 스토리지 관리` | `WebSocket` `Redis Pub/Sub` <br> `채팅방 생성` <br> `실시간 채팅` <br> `거래 기능` | `Spring Security` `JWT` <br> `OAuth2.0` `소셜 로그인` <br> `Jmeter` `validation`|


